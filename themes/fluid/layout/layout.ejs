<%
var banner_img_height = parseFloat(page.banner_img_height || theme.index.banner_img_height)
var colorSchema = theme.dark_mode && theme.dark_mode.enable && theme.dark_mode.default ? theme.dark_mode.default : ''
%>

<!DOCTYPE html>
<html lang="<%= config.language %>" <%= colorSchema ? `data-default-color-scheme=${colorSchema}` : '' %>>

<%- partial('_partials/head.ejs') %>

<body>
  <%- inject_point('bodyBegin') %>

  <header>
    <%- inject_point('header') %>
  </header>

  <main>

    <% if(is_post() || page.layout === '404') { %>
      <%- body %>
    <% } else { %>
      <div class="container nopadding-x-md">
        <div id="board"
          <%- banner_img_height >= 100 && theme.banner && theme.banner.parallax ? 'style="margin-top: 0"' : '' %>>
          <% if(page.layout === 'about') { %>
            <div class="about-avatar">
              <img src="<%= url_for(theme.about.avatar) %>" class="img-fluid" alt="avatar">
            </div>
          <% } %>
          <div class="container">
            <div class="row">
              <div class="col-12 col-md-10 m-auto">
                <%- body %>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% } %>

    <% if (theme.scroll_top_arrow.enable) { %>
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    <% } %>

    <% if (theme.search.enable) { %>
      <%- partial('_partials/search.ejs') %>
    <% } %>

    <% if (theme.custom_html) { %>
      <div class="col-lg-7 mx-auto nopadding-x-md">
        <div class="container custom mx-auto">
          <%- theme.custom_html %>
        </div>
      </div>
    <% } %>
  </main>

  <footer>
    <%- inject_point('footer') %>
  </footer>

  <!-- Scripts -->
  <%- partial('_partials/scripts.ejs') %>

  <%- inject_point('bodyEnd') %>

  <noscript>
    <div class="noscript-warning"><%- __('noscript_warning') %></div>
  </noscript>

<!-- 1. 全局鼠标烟花特效 -->
<canvas id="fireworks" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;pointer-events:none;background:transparent;"></canvas>
<script>
const c = document.getElementById("fireworks");
const ctx = c.getContext("2d");
function resizeCanvas() {
  c.width = window.innerWidth;
  c.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

class Particle {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.size = Math.random() * 2 + 1;
    this.vx = (Math.random() - 0.5) * 5;
    this.vy = (Math.random() - 0.5) * 5;
    // 适配深色/浅色模式
    const isDark = document.documentElement.dataset.defaultColorScheme === 'dark';
    this.color = isDark 
      ? `rgb(${Math.random()*255|0},${Math.random()*255|0},${Math.random()*255|0})`
      : `rgb(${Math.random()*100+155|0},${Math.random()*100+155|0},${Math.random()*100+155|0})`;
    this.life = 30;
  }
  update() {
    this.x += this.vx;
    this.y += this.vy;
    this.size *= 0.95;
    this.life--;
  }
  draw() {
    ctx.fillStyle = this.color;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fill();
  }
}

let particles = [];
document.addEventListener('mousemove', (e) => {
  for (let i = 0; i < 2; i++) {
    particles.push(new Particle(e.clientX, e.clientY));
  }
});

function animateFireworks() {
  ctx.fillStyle = "rgba(0,0,0,0.05)";
  ctx.fillRect(0, 0, c.width, c.height);
  for (let i = particles.length - 1; i >= 0; i--) {
    particles[i].update();
    particles[i].draw();
    if (particles[i].life <= 0) {
      particles.splice(i, 1);
    }
  }
  requestAnimationFrame(animateFireworks);
}
animateFireworks();
</script>

<!-- 2. Banner背景（图片/视频）+ Hover烟花 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const useVideoBanner = false; // 默认为图片模式（稳定），需要视频时改为true
  const banner = document.getElementById('banner');
  if (!banner) return;
  
  if (useVideoBanner) {
    banner.style.background = 'none';
    const video = document.createElement('video');
    video.src = '/video/banner-video.mp4'; // 视频路径：根目录/video文件夹下
    video.autoplay = true;
    video.loop = true;
    video.muted = true;
    video.playbackRate = 0.8;
    video.style.cssText = `
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -1;
    `;
    banner.appendChild(video);
    // 视频加载失败自动降级为图片
    video.addEventListener('error', () => {
      setImageBanner();
    });
  } else {
    setImageBanner();
  }

  // 图片背景配置（默认生效）
  function setImageBanner() {
    banner.style.background = 'url(/img/default.png) no-repeat center center';
    banner.style.backgroundSize = 'cover';
  }

  // Banner Hover烟花特效
  const canvas = document.createElement('canvas');
  canvas.id = 'banner-fireworks';
  canvas.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;z-index:1;pointer-events:none;background:transparent;";
  banner.appendChild(canvas);
  
  function resizeBannerCanvas() {
    const rect = banner.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    canvas.style.top = `${rect.top}px`;
    canvas.style.left = `${rect.left}px`;
  }
  resizeBannerCanvas();
  window.addEventListener('resize', resizeBannerCanvas);
  
  const ctx2 = canvas.getContext("2d");
  let bannerParticles = [];
  let isHoverBanner = false;
  let hoverX = 0, hoverY = 0;
  
  banner.addEventListener('mouseenter', () => isHoverBanner = true);
  banner.addEventListener('mouseleave', () => isHoverBanner = false);
  banner.addEventListener('mousemove', (e) => {
    const rect = banner.getBoundingClientRect();
    hoverX = e.clientX - rect.left;
    hoverY = e.clientY - rect.top;
  });
  
  function createBannerParticle() {
    if (!isHoverBanner) return;
    const centerX = hoverX;
    const centerY = hoverY;
    for (let i = 0; i < 6; i++) {
      const angle = (i / 8) * Math.PI * 2;
      const distance = Math.random() * 15 + 5;
      // 适配深色/浅色模式
      const isDark = document.documentElement.dataset.defaultColorScheme === 'dark';
      const color = isDark 
        ? `rgb(${Math.floor(Math.random()*220+35)},${Math.floor(Math.random()*220+35)},${Math.floor(Math.random()*220+35)})`
        : `rgb(${Math.floor(Math.random()*100+155)},${Math.floor(Math.random()*100+155)},${Math.floor(Math.random()*100+155)})`;
      bannerParticles.push({
        x: centerX + Math.cos(angle) * distance,
        y: centerY + Math.sin(angle) * distance,
        size: Math.random() * 3 + 2,
        vx: Math.cos(angle) * (Math.random() * 2 + 1),
        vy: Math.sin(angle) * (Math.random() * 2 + 1),
        color: color,
        life: Math.random() * 30 + 20
      });
    }
  }
  
  setInterval(createBannerParticle, 100);
  
  function animateBannerFireworks() {
    ctx2.clearRect(0, 0, canvas.width, canvas.height);
    if (isHoverBanner) {
      ctx2.fillStyle = "rgba(0,0,0,0.1)";
      ctx2.fillRect(0, 0, canvas.width, canvas.height);
    }
    
    for (let i = bannerParticles.length - 1; i >= 0; i--) {
      const p = bannerParticles[i];
      ctx2.fillStyle = p.color;
      ctx2.beginPath();
      ctx2.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx2.fill();
      
      p.x += p.vx;
      p.y += p.vy;
      p.size *= 0.97;
      p.life--;
      
      if (p.life <= 0) bannerParticles.splice(i, 1);
    }
    requestAnimationFrame(animateBannerFireworks);
  }
  animateBannerFireworks();
});
</script>

<!-- 3. 枫叶飘落特效（带开关） -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const enableMapleLeaf = true; // false 可关闭枫叶特效
  if (!enableMapleLeaf) return;
  
  const canvas = document.createElement('canvas');
  canvas.id = 'mapleLeafCanvas';
  canvas.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -2; /* 层级低于全局烟花，避免覆盖 */
    pointer-events: none;
  `;
  document.body.appendChild(canvas);
  const ctx = canvas.getContext('2d');
  
  let width, height;
  function resizeCanvas() {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
  }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);
  
  // 枫叶SVG（无需额外图片）
  const leafImg = new Image();
  leafImg.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjZTk1MDUwIiBkPSJNMzg0IDM1MkM0MjAuNiAzNTIgNDU0IDM3MiA0NTQgNDA2LjRDMzYwLjYgNDE2IDMwNCAzNTIuNCAzMDQgMzA3LjJDMzA0IDI2MiAzNjAuNiAyMDguOCA0MjQgMjE4LjRDMzkwLjYgMTA1LjYgMjcwLjYgMCAxNTYgMEMxMjUuNCAxMDUuNiA5NiAyMDguOCA2Mi42IDIxOC40QzEyNiAyMDguOCAxODIuNiAyNjIgMTgyLjYgMzA3LjJDMTgyLjYgMzUyLjQgMTI2IDQxNiAzMiA0MDYuNEMzMiAzNzIgNjUuNCAzNTIgMTAyLjYgMzUyQzE3NiAzNTIgMjAwIDM1MiAyMDAgMzUyQzIwMCAzNTIgMjU2IDM1MiAzMjAgMzUyWiIvPjwvc3ZnPg==';
  
  class MapleLeaf {
    constructor() {
      this.reset();
    }
    
    reset() {
      this.x = Math.random() * width;
      this.y = -50 - Math.random() * 200;
      this.size = 15 + Math.random() * 20;
      this.speedY = 1 + Math.random() * 3;
      this.speedX = (Math.random() - 0.5) * 2;
      this.rotation = Math.random() * Math.PI * 2;
      this.rotationSpeed = (Math.random() - 0.5) * 0.03;
    }
    
    update() {
      this.y += this.speedY;
      this.x += this.speedX;
      this.rotation += this.rotationSpeed;
      
      if (this.y > height + 50) {
        this.reset();
      }
    }
    
    draw() {
      ctx.save();
      ctx.translate(this.x, this.y);
      ctx.rotate(this.rotation);
      ctx.drawImage(leafImg, -this.size/2, -this.size/2, this.size, this.size);
      ctx.restore();
    }
  }
  
  const leaves = [];
  const leafCount = 15; // 枫叶数量，可调整
  for (let i = 0; i < leafCount; i++) {
    leaves.push(new MapleLeaf());
  }
  
  function animate() {
    ctx.clearRect(0, 0, width, height);
    leaves.forEach(leaf => {
      leaf.update();
      leaf.draw();
    });
    requestAnimationFrame(animate);
  }
  
  leafImg.onload = animate;
});
</script>

<!-- 4. 可拖动+贴边的宫崎骏风格黑猫 -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const enableCat = true;
  if (!enableCat) return;
  
  const cat = document.createElement('div');
  cat.id = 'ghibli-cat';
  cat.style.cssText = `
    position: fixed;
    width: 120px;
    height: 100px;
    z-index: 999;
    pointer-events: auto;
    cursor: grab; /* 拖动时显示抓手图标 */
    transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
  `;
  document.body.appendChild(cat);

  const pawContainer = document.createElement('div');
  pawContainer.id = 'paw-prints';
  pawContainer.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 998;
    pointer-events: none;
  `;
  document.body.appendChild(pawContainer);

  // 猫的状态（新增拖动相关属性）
  const catState = {
    x: Math.random() * (window.innerWidth - 120),
    y: Math.random() * (window.innerHeight - 100),
    directionX: Math.random() > 0.5 ? 1 : -1,
    directionY: Math.random() > 0.5 ? 1 : -1,
    speed: 1 + Math.random() * 1.2,
    isMoving: true,
    isFlipped: false,
    isSitting: false,
    actionCooldown: 0,
    lastPawPosition: 0,
    pawInterval: 60,
    isDragging: false, // 是否正在拖动
    offsetX: 0,        // 拖动偏移量
    offsetY: 0
  };

  // 猫的外观（不变）
  cat.innerHTML = `
    <div class="cat-body" style="
      width: 100%;
      height: 100%;
      position: relative;
      transition: transform 0.3s ease;
    ">
      <!-- 躯干 -->
      <div style="position: absolute; top: 40px; left: 20px; width: 80px; height: 40px; background: #000; border-radius: 40% 50% 30% 30%;"></div>
      <!-- 头部 -->
      <div style="position: absolute; top: 15px; left: 30px; width: 60px; height: 45px; background: #000; border-radius: 55% 55% 50% 50%;"></div>
      <!-- 耳朵 -->
      <div style="position: absolute; top: 5px; left: 25px; width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 25px solid #000; transform: rotate(-15deg);">
        <div style="position: absolute; top: 10px; left: -5px; width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 15px solid #e0e0e0;"></div>
      </div>
      <div style="position: absolute; top: 5px; left: 87px; width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 25px solid #000; transform: rotate(15deg);">
        <div style="position: absolute; top: 10px; left: -5px; width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 15px solid #e0e0e0;"></div>
      </div>
     <!-- 尾巴 -->
      <div class="cat-tail" style="position: absolute; top: 50px; left: 90px; width: 35px; height: 6px; background: #000; border-radius: 3px; transform: rotate(-20deg);"></div>
      <!-- 四肢 -->
      <div style="position: absolute; top: 70px; left: 30px; width: 12px; height: 15px; background: #000; border-radius: 40%;"></div>
      <div style="position: absolute; top: 70px; left: 78px; width: 12px; height: 15px; background: #000; border-radius: 40%;"></div>
      <!-- 脚掌肉垫 -->
      <div style="position: absolute; top: 83px; left: 30px; width: 12px; height: 4px; background: #555; border-radius: 50%;"></div>
      <div style="position: absolute; top: 83px; left: 78px; width: 12px; height: 4px; background: #555; border-radius: 50%;"></div>
      <!-- 绿色眼睛 -->
      <div class="cat-eyes" style="position: absolute; top: 30px; left: 40px; width: 40px; height: 10px; display: flex; justify-content: space-between;">
        <div style="width: 10px; height: 10px; background: #4CAF50; border-radius: 40% 60% 50% 50%; position: relative; overflow: hidden; box-shadow: inset 0 0 3px rgba(0,0,0,0.2);">
          <div style="position: absolute; top: 2px; left: 3px; width: 4px; height: 6px; background: #1B5E20; border-radius: 30%;"></div>
          <div style="position: absolute; top: 1px; left: 1px; width: 3px; height: 3px; background: rgba(255,255,255,0.9); border-radius: 50%;"></div>
        </div>
        <div style="width: 10px; height: 10px; background: #4CAF50; border-radius: 60% 40% 50% 50%; position: relative; overflow: hidden; box-shadow: inset 0 0 3px rgba(0,0,0,0.2);">
          <div style="position: absolute; top: 2px; left: 3px; width: 4px; height: 6px; background: #1B5E20; border-radius: 30%;"></div>
          <div style="position: absolute; top: 1px; left: 6px; width: 3px; height: 3px; background: rgba(255,255,255,0.9); border-radius: 50%;"></div>
        </div>
      </div>
      <!-- 鼻子和嘴 -->
      <div style="position: absolute; top: 45px; left: 57px; width: 6px; height: 6px; background: #ffd700; border-radius: 50%;"></div>
      <div style="position: absolute; top: 50px; left: 58px; width: 4px; height: 3px; border: 1px solid #333; border-top: none; border-radius: 0 0 3px 3px;"></div>
    </div>
    <!-- 文字气泡 -->
    <div class="cat-speech" style="
      position: absolute;
      top: -60px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 10px 18px;
      border-radius: 15px;
      font-size: 14px;
      color: #333;
      white-space: nowrap;
      display: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      border: 1px solid #e0e0e0;
    "></div>
  `;

  const speechTexts = [
    "爸爸。",
    "妈妈。",
    "我想吃猫条呢。",
    "喂喂喂！我需要被打屁屁。",
    "大胆我呀是一只超勇敢的小猫咪呢。", 
    "拖我到边缘，我会趴好哦～",
    "被抓住啦！要带我去哪里？",
    "贴在边上晒太阳真舒服～",
    "你知道吗？我会自己找地方待着～",
    "拖动的时候要小心我的尾巴呀～"
  ];

  // 奶白色脚印（已保留你的设置）
  function createPawPrint(x, y) {
    const paw = document.createElement('div');
    paw.innerHTML = `
      <div style="position: absolute; width: 8px; height: 8px; background: rgba(245, 245, 220, 0.8); border-radius: 40%;"></div>
      <div style="position: absolute; top: -5px; left: 5px; width: 6px; height: 6px; background: rgba(245, 245, 220, 0.8); border-radius: 40%;"></div>
      <div style="position: absolute; top: -5px; left: -5px; width: 6px; height: 6px; background: rgba(245, 245, 220, 0.8); border-radius: 40%;"></div>
    `;
    paw.style.cssText = `
      position: absolute;
      left: ${x}px;
      top: ${y}px;
      transform: rotate(${Math.random() * 30 - 15}deg);
      opacity: 0.7;
      transition: opacity 3s ease-out;
    `;
    pawContainer.appendChild(paw);

    setTimeout(() => {
      paw.style.opacity = '0';
      setTimeout(() => paw.remove(), 3000);
    }, 5000);
  }

  // 拖动功能实现
  cat.addEventListener('mousedown', (e) => {
    catState.isDragging = true;
    catState.isMoving = false; // 拖动时停止自动移动
    cat.style.cursor = 'grabbing'; // 拖动中显示抓手紧握图标
    // 计算鼠标在猫元素内的偏移量
    catState.offsetX = e.clientX - catState.x;
    catState.offsetY = e.clientY - catState.y;
    // 停止默认行为避免选中文字
    e.preventDefault();
  });

  document.addEventListener('mousemove', (e) => {
    if (!catState.isDragging) return;
    // 根据鼠标位置和偏移量更新猫的位置
    catState.x = e.clientX - catState.offsetX;
    catState.y = e.clientY - catState.offsetY;
    // 限制猫在屏幕内
    catState.x = Math.max(0, Math.min(catState.x, window.innerWidth - 120));
    catState.y = Math.max(0, Math.min(catState.y, window.innerHeight - 100));
    // 更新显示位置
    cat.style.left = `${catState.x}px`;
    cat.style.top = `${catState.y}px`;
  });

  document.addEventListener('mouseup', () => {
    if (!catState.isDragging) return;
    catState.isDragging = false;
    cat.style.cursor = 'grab';
    // 拖动结束后检查是否贴边
    checkEdgeSnap();
    // 3秒后恢复自动移动
    setTimeout(() => {
      if (!catState.isSitting) catState.isMoving = true;
    }, 3000);
  });

  // 贴边逻辑：距离边缘20px内自动吸附
  function checkEdgeSnap() {
    const edgeTolerance = 20; // 吸附触发距离
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;

    // 贴左边缘
    if (catState.x <= edgeTolerance) {
      catState.x = 0;
      catState.isFlipped = false; // 面朝右
      cat.querySelector('.cat-body').style.transform = 'scaleX(1)';
      cat.querySelector('.cat-tail').style.left = '90px';
      cat.querySelector('.cat-tail').style.transform = 'rotate(-20deg)';
    }
    // 贴右边缘
    else if (catState.x >= windowWidth - 120 - edgeTolerance) {
      catState.x = windowWidth - 120;
      catState.isFlipped = true; // 面朝左
      cat.querySelector('.cat-body').style.transform = 'scaleX(-1)';
      cat.querySelector('.cat-tail').style.left = '5px';
      cat.querySelector('.cat-tail').style.transform = 'rotate(20deg)';
    }
    // 贴上边缘
    if (catState.y <= edgeTolerance) {
      catState.y = 0;
    }
    // 贴下边缘
    else if (catState.y >= windowHeight - 100 - edgeTolerance) {
      catState.y = windowHeight - 100;
    }

    // 应用贴边后的位置
    cat.style.left = `${catState.x}px`;
    cat.style.top = `${catState.y}px`;
  }

  // 猫的自动移动和更新
  function updateCat() {
    if (catState.isMoving && !catState.isSitting && catState.actionCooldown <= 0 && !catState.isDragging) {
      const bounce = Math.sin(Date.now() * 0.005) * 2;
      cat.style.transform = `translateY(${bounce}px)`;

      const prevX = catState.x;
      const prevY = catState.y;

      catState.x += catState.directionX * catState.speed;
      catState.y += catState.directionY * catState.speed;

      // 限制在屏幕内
      if (catState.x <= 0 || catState.x >= window.innerWidth - 120) {
        catState.directionX *= -1;
        catState.isFlipped = !catState.isFlipped;
        cat.querySelector('.cat-body').style.transform = catState.isFlipped ? 'scaleX(-1)' : 'scaleX(1)';
        cat.querySelector('.cat-tail').style.left = catState.isFlipped ? '5px' : '90px';
        cat.querySelector('.cat-tail').style.transform = catState.isFlipped ? 'rotate(20deg)' : 'rotate(-20deg)';
      }
      if (catState.y <= 0 || catState.y >= window.innerHeight - 100) {
        catState.directionY *= -1;
      }

      // 移动时生成脚印
      const distanceMoved = Math.hypot(catState.x - prevX, catState.y - prevY);
      catState.lastPawPosition += distanceMoved;
      if (catState.lastPawPosition >= catState.pawInterval) {
        const pawX = catState.isFlipped ? catState.x + 30 : catState.x + 80;
        const pawY = catState.y + 85;
        createPawPrint(pawX, pawY);
        catState.lastPawPosition = 0;
      }

      cat.style.left = `${catState.x}px`;
      cat.style.top = `${catState.y}px`;

      // 随机坐下
      if (Math.random() < 0.0015) {
        catState.isSitting = true;
        catState.actionCooldown = 300;
        cat.querySelector('.cat-body').style.transform = catState.isFlipped ? 'scaleX(-1) translateY(5px)' : 'translateY(5px)';
      }
    } else if (catState.actionCooldown > 0) {
      catState.actionCooldown--;
      if (catState.actionCooldown === 0 && catState.isSitting) {
        catState.isSitting = false;
        cat.querySelector('.cat-body').style.transform = catState.isFlipped ? 'scaleX(-1)' : 'scaleX(1)';
      }
    } else {
      cat.style.transform = 'translateY(0)';
    }

    requestAnimationFrame(updateCat);
  }

  // 点击互动
  cat.addEventListener('click', () => {
    if (catState.isSitting) {
      catState.isSitting = false;
      catState.isMoving = true;
      catState.actionCooldown = 0;
      cat.querySelector('.cat-body').style.transform = catState.isFlipped ? 'scaleX(-1)' : 'scaleX(1)';
    } else {
      catState.isMoving = !catState.isMoving;
      catState.actionCooldown = 200;
    }

    const speech = cat.querySelector('.cat-speech');
    speech.textContent = speechTexts[Math.floor(Math.random() * speechTexts.length)];
    speech.style.display = 'block';
    setTimeout(() => { 
      speech.style.opacity = '0';
      setTimeout(() => {
        speech.style.display = 'none';
        speech.style.opacity = '1';
      }, 500);
    }, 4000);

    const pupils = cat.querySelectorAll('.cat-eyes div div:first-child');
    pupils.forEach(p => p.style.width = '6px');
    setTimeout(() => {
      pupils.forEach(p => p.style.width = '4px');
    }, 800);
  });

  // 窗口大小变化时调整位置
  window.addEventListener('resize', () => {
    catState.x = Math.min(catState.x, window.innerWidth - 120);
    catState.y = Math.min(catState.y, window.innerHeight - 100);
    cat.style.left = `${catState.x}px`;
    cat.style.top = `${catState.y}px`;
    checkEdgeSnap(); //  resize后重新检查贴边
  });

  // 初始化位置检查贴边
  checkEdgeSnap();
  updateCat();
});
</script>

<!-- 5. 博文标题点击炸开特效 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const postTitles = document.querySelectorAll('.index-header a');
  
  postTitles.forEach(title => {
    title.style.opacity = 1;
  });
  
  postTitles.forEach(title => {
    title.addEventListener('click', function(e) {
      const titleText = this.textContent.trim();
      if (!titleText) return;
      
      e.preventDefault();
      const targetUrl = this.href;
      const rect = this.getBoundingClientRect();
      
      this.style.opacity = 0;
      
      for (let i = 0; i < titleText.length; i++) {
        for (let j = 0; j < 4; j++) {
          const particle = document.createElement('span');
          particle.textContent = titleText[i];
          // 适配深色/浅色模式
          const isDark = document.documentElement.dataset.defaultColorScheme === 'dark';
          const color = isDark 
            ? `rgb(${Math.random()*255|0},${Math.random()*255|0},${Math.random()*255|0})`
            : `rgb(${Math.random()*100+155|0},${Math.random()*100+155|0},${Math.random()*100+155|0})`;
          particle.style.cssText = `
            position: fixed;
            left: ${rect.left + i * 14 + Math.random() * 8}px;
            top: ${rect.top + Math.random() * 10 - 5}px;
            color: ${color};
            font-size: ${14 + Math.random() * 6}px;
            font-weight: bold;
            pointer-events: none;
            z-index: 9999;
            transform: rotate(${Math.random() * 30 - 15}deg);
            transition: all 0.5s cubic-bezier(0.17, 0.67, 0.83, 0.67);
          `;
          document.body.appendChild(particle);
          
          setTimeout(() => {
            const angle = Math.random() * Math.PI * 2;
            const distance = 30 + Math.random() * 40;
            particle.style.transform = `translate(${Math.cos(angle)*distance}px, ${Math.sin(angle)*distance}px) rotate(${Math.random()*60-30}deg)`;
            particle.style.opacity = 0;
          }, 30);
          
          setTimeout(() => particle.remove(), 500);
        }
      }
      
      setTimeout(() => {
        this.style.opacity = 1;
        window.location.href = targetUrl;
      }, 300);
    });
  });

  window.addEventListener('popstate', function() {
    postTitles.forEach(title => {
      title.style.opacity = 1;
    });
  });
});
</script>

<!-- 6. 全局样式（优化层级和适配） -->
<style>
/* 导航栏彩虹效果 */
.navbar-brand strong {
  color: #fff !important;
  font-weight: bold !important;
  transition: all 0.3s ease !important;
}
.navbar-brand:hover strong {
  background: linear-gradient(90deg, 
    #ff0000, #ff9900, #ffff00, 
    #33cc33, #3366ff, #9933ff, #ff33cc
  ) !important;
  background-size: 300% 100% !important;
  -webkit-background-clip: text !important;
  background-clip: text !important;
  color: transparent !important;
  animation: rainbow 2s linear infinite !important;
}

.nav-link span {
  color: #fff !important;
  transition: all 0.3s ease !important;
}
.nav-link:hover span {
  background: linear-gradient(90deg, 
    #ff0000, #ff9900, #ffff00, 
    #33cc33, #3366ff, #9933ff, #ff33cc
  ) !important;
  background-size: 300% 100% !important;
  -webkit-background-clip: text !important;
  background-clip: text !important;
  color: transparent !important;
  animation: rainbow 2s linear infinite !important;
}

@keyframes rainbow {
  0% { background-position: 0% 50%; }
  100% { background-position: 300% 50%; }
}

/* 基础样式优化 */
.navbar-brand, .nav-link {
  background: none !important;
  color: #fff !important;
}
.navbar-brand:focus strong,
.nav-link:focus span {
  color: #fff !important;
  outline: none !important;
}

.index-header a {
  display: inline-block !important;
  transition: opacity 0.3s ease !important;
}

.banner .mask {
  background-color: rgba(0,0,0,0.4) !important;
}
.banner-text span {
  color: #fff !important;
  font-weight: bold !important;
  text-shadow: 0 2px 8px rgba(0,0,0,0.8) !important; /* 文字加阴影，更清晰 */
}

/* 确保内容层级高于背景特效 */
.post-content, .container {
  position: relative;
  z-index: 10;
}

/* 适配移动端 */
@media (max-width: 768px) {
  #banner { height: 300px !important; }
  .banner-text span:first-child { font-size: 1.8rem !important; }
  .banner-text span:last-child { font-size: 1rem !important; }
  #ghibli-cat { width: 100px !important; height: 80px !important; } /* 移动端缩小黑猫 */
}
</style>
</body>

</html>