<%
var banner_img_height = parseFloat(page.banner_img_height || theme.index.banner_img_height)
var colorSchema = theme.dark_mode && theme.dark_mode.enable && theme.dark_mode.default ? theme.dark_mode.default : ''
%>

<!DOCTYPE html>
<html lang="<%= config.language %>" <%= colorSchema ? `data-default-color-scheme=${colorSchema}` : '' %>>

<%- partial('_partials/head.ejs') %>

<body>
  <%- inject_point('bodyBegin') %>

  <header>
    <%- inject_point('header') %>
  </header>

  <main>
    <% if(is_post() || page.layout === '404') { %>
      <%- body %>
    <% } else { %>
      <div class="container nopadding-x-md">
        <div id="board"
          <%- banner_img_height >= 100 && theme.banner && theme.banner.parallax ? 'style="margin-top: 0"' : '' %>>
          <% if(page.layout === 'about') { %>
            <div class="about-avatar">
              <img src="<%= url_for(theme.about.avatar) %>" class="img-fluid" alt="avatar">
            </div>
          <% } %>
          <div class="container">
            <div class="row">
              <div class="col-12 col-md-10 m-auto">
                <%- body %>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% } %>

    <% if (theme.scroll_top_arrow.enable) { %>
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    <% } %>

    <% if (theme.search.enable) { %>
      <%- partial('_partials/search.ejs') %>
    <% } %>

    <% if (theme.custom_html) { %>
      <div class="col-lg-7 mx-auto nopadding-x-md">
        <div class="container custom mx-auto">
          <%- theme.custom_html %>
        </div>
      </div>
    <% } %>
  </main>

  <footer>
    <%- inject_point('footer') %>
  </footer>

  <!-- Scripts -->
  <%- partial('_partials/scripts.ejs') %>

  <%- inject_point('bodyEnd') %>

  <noscript>
    <div class="noscript-warning"><%- __('noscript_warning') %></div>
  </noscript>

<!-- 放在 _layout.ejs 的 </body> 前面 -->

<!-- 1. 烟花背景特效（保留） -->
<canvas id="fireworks" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;pointer-events:none;background:transparent;"></canvas>
<script>
const c = document.getElementById("fireworks");
const ctx = c.getContext("2d");
function resizeCanvas() {
  c.width = window.innerWidth;
  c.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

class Particle {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.size = Math.random() * 3 + 1;
    this.vx = (Math.random() - 0.5) * 6;
    this.vy = (Math.random() - 0.5) * 6;
    this.color = `rgb(${Math.random()*255|0},${Math.random()*255|0},${Math.random()*255|0})`;
    this.life = 30;
  }
  update() {
    this.x += this.vx;
    this.y += this.vy;
    this.size *= 0.95;
    this.life--;
  }
  draw() {
    ctx.fillStyle = this.color;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fill();
  }
}

let particles = [];
document.addEventListener('mousemove', (e) => {
  for (let i = 0; i < 3; i++) {
    particles.push(new Particle(e.clientX, e.clientY));
  }
});

function animateFireworks() {
  ctx.fillStyle = "rgba(0,0,0,0.05)";
  ctx.fillRect(0, 0, c.width, c.height);
  for (let i = particles.length - 1; i >= 0; i--) {
    particles[i].update();
    particles[i].draw();
    if (particles[i].life <= 0) {
      particles.splice(i, 1);
    }
  }
  requestAnimationFrame(animateFireworks);
}
animateFireworks();
</script>

<!-- 2. banner 背景（图片/视频双模式）+ hover 烟花特效（保留） -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const useVideoBanner = true; // true=视频，false=图片
  const banner = document.getElementById('banner');
  if (!banner) return;
  
  if (useVideoBanner) {
    banner.style.background = 'none';
    const video = document.createElement('video');
    video.src = '/video/banner-video.mp4';
    video.autoplay = true;
    video.loop = true;
    video.muted = true;
    video.playbackRate = 0.8;
    video.style.cssText = `position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:-1;`;
    banner.appendChild(video);
    video.addEventListener('error', () => {
      banner.style.background = 'url(/img/default.png) no-repeat center center';
      banner.style.backgroundSize = 'cover';
    });
  } else {
    banner.style.background = 'url(/img/default.png) no-repeat center center';
    banner.style.backgroundSize = 'cover';
  }

  // banner hover 烟花
  const canvas = document.createElement('canvas');
  canvas.id = 'banner-fireworks';
  canvas.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;z-index:1;pointer-events:none;background:transparent;";
  banner.appendChild(canvas);
  
  function resizeBannerCanvas() {
    const rect = banner.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    canvas.style.top = `${rect.top}px`;
    canvas.style.left = `${rect.left}px`;
  }
  resizeBannerCanvas();
  window.addEventListener('resize', resizeBannerCanvas);
  
  const ctx2 = canvas.getContext("2d");
  let bannerParticles = [];
  let isHoverBanner = false;
  let hoverX = 0, hoverY = 0;
  
  banner.addEventListener('mouseenter', () => isHoverBanner = true);
  banner.addEventListener('mouseleave', () => isHoverBanner = false);
  banner.addEventListener('mousemove', (e) => {
    const rect = banner.getBoundingClientRect();
    hoverX = e.clientX - rect.left;
    hoverY = e.clientY - rect.top;
  });
  
  function createBannerParticle() {
    if (!isHoverBanner) return;
    const centerX = hoverX;
    const centerY = hoverY;
    for (let i = 0; i < 8; i++) {
      const angle = (i / 8) * Math.PI * 2;
      const distance = Math.random() * 15 + 5;
      bannerParticles.push({
        x: centerX + Math.cos(angle) * distance,
        y: centerY + Math.sin(angle) * distance,
        size: Math.random() * 3 + 2,
        vx: Math.cos(angle) * (Math.random() * 2 + 1),
        vy: Math.sin(angle) * (Math.random() * 2 + 1),
        color: `rgb(${Math.floor(Math.random()*220+35)},${Math.floor(Math.random()*220+35)},${Math.floor(Math.random()*220+35)})`,
        life: Math.random() * 30 + 20
      });
    }
  }
  
  setInterval(createBannerParticle, 100);
  
  function animateBannerFireworks() {
    ctx2.clearRect(0, 0, canvas.width, canvas.height);
    if (isHoverBanner) {
      ctx2.fillStyle = "rgba(0,0,0,0.1)";
      ctx2.fillRect(0, 0, canvas.width, canvas.height);
    }
    
    for (let i = bannerParticles.length - 1; i >= 0; i--) {
      const p = bannerParticles[i];
      ctx2.fillStyle = p.color;
      ctx2.beginPath();
      ctx2.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx2.fill();
      
      p.x += p.vx;
      p.y += p.vy;
      p.size *= 0.97;
      p.life--;
      
      if (p.life <= 0) bannerParticles.splice(i, 1);
    }
    requestAnimationFrame(animateBannerFireworks);
  }
  animateBannerFireworks();
});
</script>


<!-- 4. 博文标题点击炸开特效（保留） -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // 匹配 Fluid 主题博文标题
  const postTitles = document.querySelectorAll('.post-item .post-title a, .post-header .post-title a');
  
  if (postTitles.length === 0) return;
  
  postTitles.forEach(title => {
    title.style.opacity = 1;
    title.addEventListener('click', function(e) {
      const titleText = this.textContent.trim();
      if (!titleText || !this.href) return;
      
      e.preventDefault();
      const targetUrl = this.href;
      const rect = this.getBoundingClientRect();
      
      this.style.opacity = 0;
      
      // 生成文字粒子
      for (let i = 0; i < titleText.length; i++) {
        for (let j = 0; j < 3; j++) {
          const particle = document.createElement('span');
          particle.textContent = titleText[i];
          particle.style.cssText = `
            position: fixed;
            left: ${rect.left + i * 14 + Math.random() * 8}px;
            top: ${rect.top + Math.random() * 10 - 5}px;
            color: rgb(${Math.random()*255|0},${Math.random()*255|0},${Math.random()*255|0});
            font-size: ${14 + Math.random() * 6}px;
            font-weight: bold;
            pointer-events: none;
            z-index: 9999;
            transform: rotate(${Math.random() * 30 - 15}deg);
            transition: all 0.5s cubic-bezier(0.17, 0.67, 0.83, 0.67);
          `;
          document.body.appendChild(particle);
          
          setTimeout(() => {
            const angle = Math.random() * Math.PI * 2;
            const distance = 30 + Math.random() * 40;
            particle.style.transform = `translate(${Math.cos(angle)*distance}px, ${Math.sin(angle)*distance}px) rotate(${Math.random()*60-30}deg)`;
            particle.style.opacity = 0;
          }, 30);
          
          setTimeout(() => particle.remove(), 500);
        }
      }
      
      // 特效结束后跳转
      setTimeout(() => {
        this.style.opacity = 1;
        window.location.href = targetUrl;
      }, 300);
    });
  });

  window.addEventListener('popstate', function() {
    postTitles.forEach(title => {
      title.style.opacity = 1;
    });
  });
});
</script>
<!-- 5. 导航栏 + Banner 文字样式 -->
<style>
/* 导航栏品牌文字彩虹效果 */
.navbar-brand strong {
  color: #fff !important;
  font-weight: bold !important;
  transition: all 0.3s ease !important;
  position: relative;
  overflow: hidden;
}

.navbar-brand:hover strong {
  background: linear-gradient(90deg, 
    #ff0000, #ff9900, #ffff00, 
    #33cc33, #3366ff, #9933ff, #ff33cc
  ) !important;
  background-size: 300% 100% !important;
  -webkit-background-clip: text !important;
  background-clip: text !important;
  color: transparent !important;
  animation: rainbow 2s linear infinite !important;
  text-shadow: 0 0 10px rgba(255,255,255,0.3) !important;
}

/* 导航链接彩虹效果 */
.nav-link span {
  color: #fff !important;
  transition: all 0.3s ease !important;
  position: relative;
}

.nav-link:hover span {
  background: linear-gradient(90deg, 
    #ff0000, #ff9900, #ffff00, 
    #33cc33, #3366ff, #9933ff, #ff33cc
  ) !important;
  background-size: 300% 100% !important;
  -webkit-background-clip: text !important;
  background-clip: text !important;
  color: transparent !important;
  animation: rainbow 2s linear infinite !important;
  transform: translateY(-1px) !important;
}

/* 彩虹动画 */
@keyframes rainbow {
  0% { background-position: 0% 50%; }
  100% { background-position: 300% 50%; }
}

/* 导航栏基础样式 */
.navbar-brand, .nav-link {
  background: none !important;
  color: #fff !important;
}

.navbar-brand:focus strong,
.nav-link:focus span {
  color: #fff !important;
  outline: none !important;
}

/* 首页头部链接样式 */
.index-header a {
  display: inline-block !important;
  transition: opacity 0.3s ease !important;
}

.index-header a:hover {
  opacity: 0.8 !important;
  transform: translateY(-1px) !important;
}

/* Banner 遮罩层样式 */
.banner .mask {
  background-color: rgba(0,0,0,0.4) !important;
  backdrop-filter: blur(2px) !important;
}

/* Banner 文字样式 */
.banner-text span {
  color: #fff !important;
  font-weight: bold !important;
  text-shadow: 0 0 8px rgba(0,0,0,0.8) !important;
  letter-spacing: 0.5px !important;
}

/* 导航栏下拉菜单样式 */
.dropdown-menu {
  backdrop-filter: blur(10px) !important;
  background: rgba(255,255,255,0.95) !important;
  border: 1px solid rgba(255,255,255,0.2) !important;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1) !important;
}

.dropdown-item:hover {
  background: rgba(102, 126, 234, 0.1) !important;
}

/* 移动端导航菜单样式 */
@media (max-width: 991.98px) {
  .navbar-collapse {
    backdrop-filter: blur(10px) !important;
    background: rgba(255,255,255,0.95) !important;
    border-radius: 10px !important;
    margin-top: 10px !important;
    padding: 15px !important;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1) !important;
  }
  
  .nav-link span {
    color: #333 !important;
  }
}

/* 导航栏滚动效果 */
.navbar-scrolled {
  backdrop-filter: blur(10px) !important;
  background: rgba(255,255,255,0.95) !important;
  box-shadow: 0 2px 20px rgba(0,0,0,0.1) !important;
}

.navbar-scrolled .navbar-brand strong,
.navbar-scrolled .nav-link span {
  color: #333 !important;
}

.navbar-scrolled .navbar-brand:hover strong,
.navbar-scrolled .nav-link:hover span {
  background: linear-gradient(90deg, 
    #ff0000, #ff9900, #ffff00, 
    #33cc33, #3366ff, #9933ff, #ff33cc
  ) !important;
  background-size: 300% 100% !important;
  -webkit-background-clip: text !important;
  background-clip: text !important;
  color: transparent !important;
}

/* 活动链接指示器 */
.nav-link.active span {
  position: relative !important;
}

.nav-link.active span::after {
  content: '';
  position: absolute;
  bottom: -5px;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(90deg, #667eea, #764ba2) !important;
  border-radius: 2px;
}
</style>

<script>
// 导航栏滚动效果
document.addEventListener('DOMContentLoaded', function() {
  const navbar = document.querySelector('.navbar');
  if (!navbar) return;
  
  // 滚动监听
  window.addEventListener('scroll', function() {
    if (window.scrollY > 50) {
      navbar.classList.add('navbar-scrolled');
    } else {
      navbar.classList.remove('navbar-scrolled');
    }
  });
  
  // 设置当前活动链接
  const currentPath = window.location.pathname;
  const navLinks = document.querySelectorAll('.nav-link');
  
  navLinks.forEach(link => {
    const linkPath = link.getAttribute('href');
    if (linkPath && currentPath.includes(linkPath) && linkPath !== '/') {
      link.classList.add('active');
    }
  });
});
</script><!-- 枫叶飘落特效 -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // 创建画布（放在所有内容下方，不遮挡交互）
  const canvas = document.createElement('canvas');
  canvas.id = 'mapleLeafCanvas';
  canvas.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1; /* 低于其他内容，不影响点击 */
    pointer-events: none;
  `;
  document.body.appendChild(canvas);
  const ctx = canvas.getContext('2d');
  
  // 画布尺寸跟随窗口
  let width, height;
  function resizeCanvas() {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
  }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);
  
  // 枫叶图片（用base64避免额外请求，更轻量）
  const leafImg = new Image();
  // 枫叶图标（红色渐变枫叶，可直接用）
  leafImg.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjZTk1MDUwIiBkPSJNMzg0IDM1MkM0MjAuNiAzNTIgNDU0IDM3MiA0NTQgNDA2LjRDMzYwLjYgNDE2IDMwNCAzNTIuNCAzMDQgMzA3LjJDMzA0IDI2MiAzNjAuNiAyMDguOCA0MjQgMjE4LjRDMzkwLjYgMTA1LjYgMjcwLjYgMCAxNTYgMEMxMjUuNCAxMDUuNiA5NiAyMDguOCA2Mi42IDIxOC40QzEyNiAyMDguOCAxODIuNiAyNjIgMTgyLjYgMzA3LjJDMTgyLjYgMzUyLjQgMTI2IDQxNiAzMiA0MDYuNEMzMiAzNzIgNjUuNCAzNTIgMTAyLjYgMzUyQzE3NiAzNTIgMjAwIDM1MiAyMDAgMzUyQzIwMCAzNTIgMjU2IDM1MiAzMjAgMzUyWiIvPjwvc3ZnPg==';
  
  // 枫叶类（控制飘落逻辑）
  class MapleLeaf {
    constructor() {
      this.reset(); // 初始化位置和状态
    }
    
    // 重置枫叶到顶部随机位置
    reset() {
      this.x = Math.random() * width; // 水平随机
      this.y = -50 - Math.random() * 200; // 顶部外随机
      this.size = 15 + Math.random() * 20; // 大小随机（15-35px）
      this.speedY = 1 + Math.random() * 3; // 下落速度（1-4px/帧）
      this.speedX = (Math.random() - 0.5) * 2; // 左右摇摆速度
      this.rotation = Math.random() * Math.PI * 2; // 初始旋转角度
      this.rotationSpeed = (Math.random() - 0.5) * 0.03; // 旋转速度
    }
    
    // 更新位置和状态
    update() {
      this.y += this.speedY; // 下落
      this.x += this.speedX; // 左右移动
      this.rotation += this.rotationSpeed; // 旋转
      
      // 超出屏幕底部则重置
      if (this.y > height + 50) {
        this.reset();
      }
    }
    
    // 绘制枫叶
    draw() {
      ctx.save();
      ctx.translate(this.x, this.y); // 移动到当前位置
      ctx.rotate(this.rotation); // 旋转
      ctx.drawImage(
        leafImg, 
        -this.size/2, // 居中绘制
        -this.size/2, 
        this.size, 
        this.size
      );
      ctx.restore();
    }
  }
  
  // 创建枫叶实例（控制数量，避免卡顿）
  const leaves = [];
  const leafCount = 22; // 15片枫叶，性能友好
  for (let i = 0; i < leafCount; i++) {
    leaves.push(new MapleLeaf());
  }
  
  // 动画循环
  function animate() {
    ctx.clearRect(0, 0, width, height); // 清空画布
    leaves.forEach(leaf => {
      leaf.update();
      leaf.draw();
    });
    requestAnimationFrame(animate);
  }
  
  // 等待枫叶图片加载完成后开始动画
  leafImg.onload = animate;
});
</script>
</style>
</body>

</html>
